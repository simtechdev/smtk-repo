################################################################################
#                         NGINX VIRTUAL HOST CONFIG FILE                       #
################################################################################
#                                                                              #
# Please note what it's a DEFAULT configuration file. This is appropriate for  #
# most cases, but not for all. Check all configuration values before nginx     #
# usage.                                                                       #
#                                                                              #
################################################################################

server {
    listen          80;
    server_name     example.com;
    server_name     www.example.com;

    ############################################################################

    set         $root   "/var/www/html";
    charset     utf-8;
    root        $root;

    ############################################################################

    access_log  /var/log/nginx/example.com.access.log combined;
    error_log   /var/log/nginx/example.com.error.log;

    ############################################################################

    include xtra/error-40X.conf;
    include xtra/error-50X.conf;

    error_page 598 = @backend;

    ############################################################################

    location @statics {
        rewrite ^/(\w+)/(.*)$ /$2 break;
        access_log off;
        rewrite_log off;
        expires 14d;
        add_header Cache-Control public;
        add_header Access-Control-Allow-Origin *;
    }

    location @backend {
        try_files $uri $uri/ =404;
        fastcgi_pass backend;
        fastcgi_index index.php;
        include xtra/fastcgi_params_ssl.conf;
    }

    location ~* \.(jpeg|ico|jpg|gif|png|css|js|pdf|txt|tar|wof|woff|csv|zip) {
        try_files $uri @statics;
        access_log off;
        expires 14d;
        add_header Access-Control-Allow-Origin *;
        add_header Cache-Control public;
    }

    location / {
        if (-f $root/maintenance) {
            return 503;
        }
        index  index.php index.html index.htm;
        rewrite ^/api/(.*)$ /api.php?_d=$1&ajax_custom=1&$args last;
        try_files $uri $uri/ @fallback;
    }

    location @fallback {
        rewrite  ^(.*)$ /index.php?$args last;
    }

    location ~ /(index|admin|api).php {
        return 598;
    }

    location = /install/index.php {
        return 598;
    }

    # location = /var/upgrade/upgrade_4.2.4_ultimate-4.3.1_ultimate.tgz/restore.php {
    #     return 598;
    # }

    location ^~ /app/ {
        return 404;
        location = /app/addons/rus_exim_1c/exim_1c.php {
            return 598;
        }
    }

    location ^~ /app/payments/ {
        return 404;
        location ~ \.php$ {
            return 598;
        }
    }

    location ^~ /var/database/ {
        return 404;
    }

    location ~* \.([pP][hH][pP]|[tT][pP][lL].?)$ {
        return 404;
    }

    location ~ /\.(ht|git) {
        return 404;
    }

    ############################################################################
}

################################################################################

server {
    listen          443 spdy;
    server_name     example.com;
    server_name     www.example.com;

    ############################################################################

    charset utf-8;
    set     $root "/var/www/html";
    root    $root;

    ############################################################################

    access_log  /var/log/nginx/example.com.access.log combined;
    error_log   /var/log/nginx/example.com.error.log;

    ############################################################################

    include xtra/error-40X.conf;
    include xtra/error-50X.conf;

    error_page 598 = @backend;

    ############################################################################

    ssl                         on;
    ssl_certificate             /etc/nginx/ssl/example.com.pem;
    ssl_certificate_key         /etc/nginx/ssl/example.com.key;
    ssl_session_timeout         5m;
    ssl_session_cache           shared:SSL:16m;
    ssl_stapling                on;
    ssl_stapling_verify         on;
    resolver                    8.8.4.4 8.8.8.8 valid=300s;
    resolver_timeout            15s;
    ssl_protocols               TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers                 HIGH:!aNULL:!MD5:!kEDH;
    ssl_prefer_server_ciphers   on;
    include                     xtra/ssl.conf;

    ############################################################################

    location @statics {
        rewrite ^/(\w+)/(.*)$ /$2 break;
        access_log off;
        rewrite_log off;
        expires 14d;
        add_header Cache-Control public;
        add_header Access-Control-Allow-Origin *;
    }

    location @backend {
        try_files $uri $uri/ =404;
        fastcgi_pass backend;
        fastcgi_index index.php;
        include xtra/fastcgi_params_ssl.conf;
    }

    location ~* \.(jpeg|ico|jpg|gif|png|css|js|pdf|txt|tar|wof|woff|csv|zip) {
        try_files $uri @statics;
        access_log off;
        expires 14d;
        add_header Access-Control-Allow-Origin *;
        add_header Cache-Control public;
    }

    location / {
        if (-f $root/maintenance) {
            return 503;
        }
        index  index.php index.html index.htm;
        rewrite ^/api/(.*)$ /api.php?_d=$1&ajax_custom=1&$args last;
        try_files $uri $uri/ @fallback;
    }

    location @fallback {
        rewrite  ^(.*)$ /index.php?$args last;
    }

    location ~ /(index|admin|api).php {
        return 598;
    }

    location = /install/index.php {
        return 598;
    }

    # location = /var/upgrade/upgrade_4.2.4_ultimate-4.3.1_ultimate.tgz/restore.php {
    #     return 598;
    # }

    location ^~ /app/ {
        return 404;
        location = /app/addons/rus_exim_1c/exim_1c.php {
            return 598;
        }
    }

    location ^~ /app/payments/ {
        return 404;
        location ~ \.php$ {
            return 598;
        }
    }

    location ^~ /var/database/ {
        return 404;
    }

    location ~* \.([pP][hH][pP]|[tT][pP][lL].?)$ {
        return 404;
    }

    location ~ /\.(ht|git) {
        return 404;
    }

    ############################################################################
}

################################################################################